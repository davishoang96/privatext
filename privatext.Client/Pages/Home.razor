@page "/"
@inject IApiClient ApiClient
@inject IRandomString RandomString
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@using System.Security.Cryptography
@using System.Text
@using privatext.Client.HttpClient
@using privatext.Services

<PageTitle>Privatext</PageTitle>

<RadzenRow JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center">
    <RadzenColumn Size="3"/>
    <RadzenColumn Size="6">
        <RadzenStack Visible="@ShowMessageInput" JustifyContent="JustifyContent.Center" Orientation="Orientation.Vertical" Gap="10px">
            <RadzenStack JustifyContent="JustifyContent.Left" Orientation="Orientation.Horizontal">
                <h4>Create your private text</h4>
            </RadzenStack>
            <RadzenTextArea @bind-Value="@MessageContent" Placeholder="Enter your text here..." MaxLength="4000" Rows="15" Cols="100"></RadzenTextArea>
            <RadzenStack Orientation="Orientation.Horizontal">
                <RadzenButton Click="@CreateMessage" Text="Create" ButtonStyle="ButtonStyle.Success" />
            </RadzenStack>
        </RadzenStack>
        <RadzenStack Visible="@ShowLink" JustifyContent="JustifyContent.Center" Orientation="Orientation.Vertical" Gap="10px">
            <RadzenStack JustifyContent="JustifyContent.Left" Orientation="Orientation.Vertical">
                <RadzenStack Orientation="Orientation.Vertical">
                    <RadzenFormField Text="Link">
                        <Start>
                            <RadzenIcon Icon="http" />
                        </Start>
                        <ChildContent>
                            <RadzenTextBox @bind-Value="@MessageUrl" />
                        </ChildContent>
                        <End>
                            <RadzenIcon Visible="true" Icon="done" IconStyle="IconStyle.Secondary" />
                        </End>
                    </RadzenFormField>
                    <RadzenStack JustifyContent="JustifyContent.Center" Orientation="Orientation.Horizontal">
                        <RadzenButton>Copy link</RadzenButton>
                        <RadzenButton Click="@NewText" ButtonStyle="ButtonStyle.Success">New Text</RadzenButton>
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
        </RadzenStack>
    </RadzenColumn>
    <RadzenColumn Size="3" />
</RadzenRow>

@code {

    private string MessageContent { get; set; }
    private string MessageUrl { get; set; }
    private bool ShowMessageInput { get; set; }
    private bool ShowLink { get; set; }
    private string MessageId { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ShowMessageInput = !ShowLink;
    }

    private async Task CreateMessage()
    {
        if(string.IsNullOrEmpty(MessageContent))
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Warning", 
                Detail = "Message cannot be empty",
            });

            return;
        }

        var id = RandomString.CreateRandomString(32);
        var result = await ApiClient.CreateMessageEndpointAsync(new CreateMessageRequest
        {
            MessageDTO = new MessageDTO
            {
                MessageId = id,
                Content = MessageContent,
            },
        });

        if(result)
        {
            MessageId = id;
            MessageUrl = $"{NavigationManager.BaseUri}message/{id}";
            ShowLink = true;
            ShowMessageInput = false;

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Status",
                Detail = "Private text successfully created",
            });
        }
    }

    private void NewText()
    {
        MessageContent = MessageUrl = MessageId = string.Empty;
        ShowMessageInput = true;
        ShowLink = false;
    }
}
