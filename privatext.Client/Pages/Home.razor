@page "/"
@inject IApiClient ApiClient
@inject IRandomString RandomString
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using privatext.Common.DTO
@using privatext.Common.Request
@using privatext.Services
@inject ICryptoService CryptService;

<PageTitle>Privatext</PageTitle>
    <MudGrid Spacing="3">
    <MudItem xs="3"></MudItem>
    <MudItem xs="6">
        <MudStack Direction="Column" JustifyContent="Center">
            @if (@ShowTextInput)
            {
                <MudStack Direction="Column" JustifyContent="Center">
                    <MudText Typo="Typo.h4" Class="custom-font">New message</MudText>
                    <MudText>The message will be deleted as soon as it is read.</MudText>
                    <MudTextField Style="font-family: Consolas" Variant="Variant.Outlined" @bind-Value="@Content" Lines="10" Placeholder="Enter your text message here..." MaxLength="4000" FullWidth="true" />
                    <MudButton OnClick="@CreateMessage" Variant="Variant.Outlined" Color="Color.Success">Create</MudButton>
                </MudStack>
            }
            else
            {
                <MudStack Direction="Column" JustifyContent="Center">

                @if (@IsLoading)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                    <MudText Typo="Typo.h6">Link</MudText>
                    <MudTextField Style="font-family: Consolas" Variant="Variant.Outlined" @bind-Value="@TextUrl" />
                    <MudIconButton Icon="Icons.Material.Filled.Check" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6">Your message</MudText>
                    <MudTextField Lines="10" Style="font-family: Consolas" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="@Content" FullWidth="true" />
                    <MudText Typo="Typo.caption">(you will only see this once)</MudText>
                    <MudButton OnClick="@DeleteMessage" Variant="Variant.Outlined" Color="Color.Error">Delete</MudButton>
                    <MudButton OnClick="@NewText" Variant="Variant.Outlined" Color="Color.Success">Create</MudButton>
                }
            </MudStack>
            }
        </MudStack>
    </MudItem>
    <MudItem xs="3"></MudItem>
</MudGrid>

<style>
    .custom-font {
        font-family: 'Roboto', sans-serif;
    }
</style>

@code {

    private string Content { get; set; }
    private string TextUrl { get; set; }
    private bool ShowTextInput { get; set; }
    private string Id { get; set; }
    private bool IsLoading { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ShowTextInput = !ShowTextInput;
        IsLoading = false;
    }

    private async Task DeleteMessage()
    {
        if (string.IsNullOrEmpty(Id))
        {
            Snackbar.Add("Cannot delete the message", Severity.Error);
            return;
        }

        var res = await ApiClient.DeleteMessageEndpointAsync(new DeleteMessageRequest
        {
            MessageId = Id
        });

        if (res)
        {
            NewText();
            Snackbar.Add("Sucessfully deleted", Severity.Success);
        }
    }


    private async Task CreateMessage()
    {
        if(string.IsNullOrEmpty(Content))
        {
            Snackbar.Add("The input field cannot be empty", Severity.Warning);
            return;
        }

        ShowTextInput = false;
        IsLoading = true;

        var key = RandomString.Generate(32);
        var urlId = RandomString.Generate(4);
        var messageContent = await CryptService.Encrypt(Content, key);
        var clientKey = key.Substring(0, 9);
        var keyIdentifier = key.Substring(9);
        var result = await ApiClient.CreateMessageEndpointAsync(new CreateMessageRequest
        {
            MessageDTO = new MessageDTO
            {
                KeyIdentifer = keyIdentifier,
                MessageId = urlId,
                Content = messageContent,
            },
        });

        if(result)
        {
            Id = urlId;
            TextUrl = $"{NavigationManager.BaseUri}text/{urlId}${clientKey}";
            ShowTextInput = false;
            IsLoading = false;
            Snackbar.Add("Message saved!", Severity.Success);
        }
    }

    private void NewText()
    {
        Content = TextUrl = Id = string.Empty;
        ShowTextInput = true;
    }
}
